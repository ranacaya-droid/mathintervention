<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest for Knowledge: Word Problems</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Custom Fantasy RPG Theme Styles */
        body {
            font-family: 'Lato', sans-serif;
            background-color: #2c1e15; /* Dark wood color */
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MiIgaGVpZ2h0PSIyNiIgdmlld0JveD0iMCAwIDUyIDI2Ij48ZyBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiM5YzY5NTEiIGZpbGwtb3BhY2l0eT0iMC4xIj48cGF0aCBkPSJNMTggMHYyNmg0VjB6TTQxIDB2MjZoNFYweiIvPjwvZz48L2c+PC9zdmc+');
        }
        h1, h2, h3, .rpg-font {
            font-family: 'MedievalSharp', cursive;
        }
        .rpg-btn {
            background-color: #7a5c4f; /* Leather brown */
            border: 4px solid #4a382f; /* Darker brown */
            color: #f3e9dc; /* Parchment color */
            font-family: 'MedievalSharp', cursive;
            font-size: 1.25rem;
            padding: 8px 16px;
            border-radius: 8px;
            box-shadow: 0 5px #3a2c23;
            transition: all 0.1s ease-in-out;
            cursor: pointer;
            text-shadow: 1px 1px 2px #000;
        }
        .rpg-btn:hover {
            transform: translateY(2px);
            box-shadow: 0 3px #3a2c23;
        }
        .rpg-btn:active {
            transform: translateY(4px);
            box-shadow: 0 1px #3a2c23;
        }
        .tab-btn {
            background-color: #4a382f;
            color: #c5b8a5;
            padding: 12px 24px;
            border-radius: 10px 10px 0 0;
            border: 3px solid #3a2c23;
            border-bottom: none;
            transition: all 0.3s;
            position: relative;
            bottom: -3px;
        }
        .tab-btn.active {
            background-color: #6a4c3f;
            color: #fff;
            border-color: #3a2c23;
        }
        .quest-scroll {
            background-color: #f3e9dc; /* Parchment */
            color: #3a2c23;
            border: 15px solid transparent;
            border-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48ZGVmcz48cGF0dGVybiBpZD0icGF0dGVybiIgcGF0dGVyblVuaXRzPSJvYmplY3RCb3VuZGluZ0JveCIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSI+PHBhdGggZmlsbD0iIzdhNWM0ZiIgc3Ryb2tlPSIjNGEzODJmIiBzdHJva2Utd2lkdGg9IjIiIGQ9Ik0wLDBIMzAwVjMwMEgwWiIvPjwvcGF0dGVybj48L2RlZnM+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9InVybCgjcGF0dGVybikiLz48L3N2Zz4=') 15 stretch;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        .slide {
            padding: 2rem;
            min-height: 500px;
        }
        .draggable {
            cursor: grab;
            user-select: none;
        }
        .drop-target {
            border: 3px dashed #8a6c5f;
            min-height: 80px;
            transition: background-color 0.3s;
            background: rgba(122, 92, 79, 0.1);
            border-radius: 10px;
        }
        .drop-target.over {
            background-color: rgba(100, 150, 100, 0.3);
        }
        .feedback {
            font-size: 1.5rem;
            font-weight: bold;
            padding: 1rem;
            border-radius: 10px;
            margin-top: 1rem;
            text-align: center;
            font-family: 'MedievalSharp', cursive;
        }
        .feedback.correct {
            background-color: #e6f4ea;
            color: #2d6a4f;
            border: 2px solid #52b788;
        }
        .feedback.incorrect {
            background-color: #fde0e0;
            color: #9e2a2b;
            border: 2px solid #e56b6f;
        }
        .xp-gain {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.5rem;
            color: #ffd700;
            text-shadow: 0 0 5px #000;
            animation: fadeUp 1.5s ease-out forwards;
        }
        @keyframes fadeUp {
            0% { opacity: 1; transform: translate(-50%, 0); }
            100% { opacity: 0; transform: translate(-50%, -50px); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-4 text-center md:text-left">
            <h1 class="text-4xl md:text-5xl font-bold text-amber-200 mb-4 md:mb-0" style="text-shadow: 2px 2px 4px #000;">üìú Quest for Knowledge ‚öîÔ∏è</h1>
            <div class="flex space-x-2">
                <button id="download-work-btn" class="rpg-btn">Save Quest Log</button>
                <button id="download-pdf-btn" class="rpg-btn">Export Scroll</button>
            </div>
        </header>

        <!-- Main Navigation Tabs -->
        <nav id="main-tabs" class="flex justify-center space-x-2 z-10 relative rpg-font">
            <!-- Tabs will be generated here -->
        </nav>

        <!-- Content Area -->
        <main id="content-area" class="quest-scroll">
            <!-- Day content will be injected here -->
        </main>
    </div>

    <!-- Hidden data script for saving progress -->
    <script id="progress-data" type="application/json"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DATA ---
        const lessonData = {
          "day1": {
            "title": "The Quest for More Jewels (Add-To Problems)",
            "standard": "2.PAFR.1.3 - Solve one-step add-to, take-from, and part-part-whole real-world situations.",
            "sections": {
              "hook": [
                { "id": "d1_hook_1", "type": "content", "prompt": "A hero finds a pouch with 8 rubies. A friendly gnome gives the hero 5 more rubies. How many rubies does the hero have now?" }
              ],
              "i_do": [
                { "id": "d1_ido_1", "type": "mc", "prompt": "A wizard had 7 potions. He brewed 6 more. How many potions does he have now?", "visual": "part_part_whole_mat: {part1:{type:'potion', count:7}, part2:{type:'potion', count:6}, whole:'?'}", "data": { "options": ["12", "13", "14"] }, "correct": "13" },
                { "id": "d1_ido_2", "type": "text-box", "prompt": "An elf shot 9 arrows. Then she shot 5 more. How many arrows did she shoot in all? Write the total.", "visual": "equation_scroll: {text:'9 + 5 = ?'}", "data": { "size": 2 }, "correct": "14" },
                { "id": "d1_ido_3", "type": "true-false", "prompt": "A knight has 11 shields and gets 4 more. The correct equation is 11 + 4 = 15.", "visual": "", "data": { "options": ["True", "False"] }, "correct": "True" }
              ],
              "we_do": [
                { "id": "d1_wedo_1", "type": "mc", "prompt": "A knight polished 9 shields. Then she polished 4 more. How many shields did she polish in all?", "visual": "", "data": { "options": ["12", "13", "14"] }, "correct": "13" },
                { "id": "d1_wedo_2", "type": "mc", "prompt": "You find 8 gold coins. Your friend gives you 8 more. How many do you have?", "visual": "part_part_whole_mat: {part1:{type:'gold_coin', count:8}, part2:{type:'gold_coin', count:8}, whole:'?'}", "data": { "options": ["15", "16", "17"] }, "correct": "16" },
                { "id": "d1_wedo_3", "type": "true-false", "prompt": "6 gems plus 7 gems equals 12 gems.", "visual": "", "data": { "options": ["True", "False"] }, "correct": "False" },
                { "id": "d1_wedo_4", "type": "text-box", "prompt": "A dwarf mined 12 diamonds and 5 emeralds. How many gems did he mine in total?", "visual": "", "data": { "size": 2 }, "correct": "17" },
                { "id": "d1_wedo_5", "type": "drag-drop-match", "prompt": "Drag the total to the quest scroll.", "visual": "equation_scroll: {text:'7 + 9 = ?'}", "data": { "draggables": ["15", "16"], "dropTargets": ["Answer"] }, "correct": { "16": "Answer" } },
                { "id": "d1_wedo_6", "type": "mc", "prompt": "A party of adventurers has 5 warriors and 8 mages. How many adventurers are in the party?", "visual": "", "data": { "options": ["12", "13", "14"] }, "correct": "13" },
                { "id": "d1_wedo_7", "type": "true-false", "prompt": "You have 10 health potions and find 3 more. You now have 13.", "visual": "", "data": { "options": ["True", "False"] }, "correct": "True" },
                { "id": "d1_wedo_8", "type": "text-box", "prompt": "Solve: A dragon has 13 piles of gold and adds 6 more. How many piles now?", "visual": "", "data": { "size": 2 }, "correct": "19" },
                { "id": "d1_wedo_9", "type": "mc", "prompt": "Which scroll matches the story: 'You have 8 swords and find 4 more.'?", "visual": "", "data": { "options": ["8 - 4 = 4", "8 + 4 = 12", "12 - 4 = 8"] }, "correct": "8 + 4 = 12" },
                { "id": "d1_wedo_10", "type": "drag-drop-match", "prompt": "Match the items to the mat to find the total.", "visual": "part_part_whole_mat: {part1:'?', part2:'?', whole:'?'}", "data": { "draggables": ["6 rubies", "9 sapphires"], "dropTargets": ["Part 1", "Part 2"] }, "correct": { "6 rubies": "Part 1", "9 sapphires": "Part 2" } }
              ],
              "you_do": [
                { "id": "d1_youdo_1", "type": "mc", "prompt": "You collected 9 herbs. You find 9 more. How many herbs do you have?", "visual": "", "data": { "options": ["17", "18", "19"] }, "correct": "18" },
                { "id": "d1_youdo_2", "type": "text-box", "prompt": "A blacksmith forges 11 axes and 7 swords. How many weapons did he make?", "visual": "", "data": { "size": 2 }, "correct": "18" },
                { "id": "d1_youdo_3", "type": "true-false", "prompt": "A griffin has 13 feathers and grows 5 more. It now has 18 feathers.", "visual": "", "data": { "options": ["True", "False"] }, "correct": "True" },
                { "id": "d1_youdo_4", "type": "mc", "prompt": "A wizard reads 8 scrolls on Monday and 6 on Tuesday. How many scrolls did he read in all?", "visual": "", "data": { "options": ["13", "14", "15"] }, "correct": "14" },
                { "id": "d1_youdo_5", "type": "drag-drop-match", "prompt": "Drag the total to the equation: 12 + 8 = ?", "visual": "", "data": { "draggables": ["19", "20"], "dropTargets": ["Equation"] }, "correct": { "20": "Equation" } }
              ]
            },
            "practice_center": {
              "level1": [
                { "id": "d1_l1_q1", "type": "mc", "prompt": "A hero has 7 potions and finds 5 more. How many potions in all?", "visual": "part_part_whole_mat: {part1:{type:'potion', count:7}, part2:{type:'potion', count:5}, whole:'?'}", "data": { "options": ["11", "12", "13"] }, "correct": "12" },
                { "id": "d1_l1_q2", "type": "mc", "prompt": "There are 9 knights and 3 squires. How many people are there?", "visual": "", "data": { "options": ["11", "12", "13"] }, "correct": "12" },
                { "id": "d1_l1_q3", "type": "mc", "prompt": "You find 6 gold coins, then you find 8 more. How many coins do you have?", "visual": "item_counter: {type:'gold_coin', count:14}", "data": { "options": ["14", "15", "16"] }, "correct": "14" },
                { "id": "d1_l1_q4", "type": "mc", "prompt": "An elf has 10 arrows and makes 5 more. How many arrows does she have?", "visual": "", "data": { "options": ["14", "15", "16"] }, "correct": "15" },
                { "id": "d1_l1_q5", "type": "mc", "prompt": "A dragon has 8 piles of gold and gets 4 more. How many piles now?", "visual": "", "data": { "options": ["12", "13", "14"] }, "correct": "12" },
                { "id": "d1_l1_q6", "type": "mc", "prompt": "A wizard learns 7 new spells and then learns 7 more. How many spells did he learn?", "visual": "", "data": { "options": ["13", "14", "15"] }, "correct": "14" },
                { "id": "d1_l1_q7", "type": "mc", "prompt": "A blacksmith made 9 swords and 9 axes. How many weapons did he make?", "visual": "", "data": { "options": ["17", "18", "19"] }, "correct": "18" },
                { "id": "d1_l1_q8", "type": "mc", "prompt": "You have 11 health points and gain 6 more. How many health points do you have?", "visual": "", "data": { "options": ["17", "18", "19"] }, "correct": "17" },
                { "id": "d1_l1_q9", "type": "mc", "prompt": "A quest gives 5 XP. Another quest gives 8 XP. How much XP did you earn?", "visual": "", "data": { "options": ["12", "13", "14"] }, "correct": "13" },
                { "id": "d1_l1_q10", "type": "mc", "prompt": "There are 12 goblins. 7 more show up. How many goblins are there now?", "visual": "", "data": { "options": ["18", "19", "20"] }, "correct": "19" },
                { "id": "d1_l1_q11", "type": "true-false", "prompt": "If you have 8 rubies and find 3 more, you will have 11 rubies.", "visual": "", "data": { "options": ["True", "False"] }, "correct": "True" },
                { "id": "d1_l1_q12", "type": "true-false", "prompt": "A castle has 10 towers. They build 4 more. Now the castle has 13 towers.", "visual": "", "data": { "options": ["True", "False"] }, "correct": "False" },
                { "id": "d1_l1_q13", "type": "true-false", "prompt": "6 dragons plus 5 dragons equals 11 dragons.", "visual": "", "data": { "options": ["True", "False"] }, "correct": "True" },
                { "id": "d1_l1_q14", "type": "true-false", "prompt": "You need 15 logs to build a raft. You have 9 and find 5 more. You have enough logs.", "visual": "", "data": { "options": ["True", "False"] }, "correct": "False" },
                { "id": "d1_l1_q15", "type": "true-false", "prompt": "A quest requires 12 potions. You have 8 and brew 4 more. You have exactly enough.", "visual": "", "data": { "options": ["True", "False"] }, "correct": "True" },
                { "id": "d1_l1_q16", "type": "drag-drop-match", "prompt": "Match the quest to the total treasure.", "visual": "", "data": { "draggables": ["8 gold + 7 silver", "10 rubies + 5 emeralds"], "dropTargets": ["15", "14"] }, "correct": { "8 gold + 7 silver": "15", "10 rubies + 5 emeralds": "15" } },
                { "id": "d1_l1_q17", "type": "drag-drop-match", "prompt": "Match the equation scroll to the answer.", "visual": "", "data": { "draggables": ["9 + 6 = ?", "7 + 7 = ?"], "dropTargets": ["14", "15"] }, "correct": { "9 + 6 = ?": "15", "7 + 7 = ?": "14" } },
                { "id": "d1_l1_q18", "type": "drag-drop-match", "prompt": "Drag the correct total to the mat.", "visual": "part_part_whole_mat: {part1: 11, part2: 8, whole:'?'}", "data": { "draggables": ["18", "19"], "dropTargets": ["Whole"] }, "correct": { "19": "Whole" } },
                { "id": "d1_l1_q19", "type": "drag-drop-match", "prompt": "Drag the answer to the scroll.", "visual": "equation_scroll: {text:'13 + 5 = ?'}", "data": { "draggables": ["17", "18"], "dropTargets": ["Answer"] }, "correct": { "18": "Answer" } },
                { "id": "d1_l1_q20", "type": "drag-drop-match", "prompt": "A hero has 6 swords and 6 shields. Match the story to the total number of items.", "visual": "", "data": { "draggables": ["6 swords + 6 shields"], "dropTargets": ["12", "13"] }, "correct": { "6 swords + 6 shields": "12" } }
              ],
              "level2": [
                { "id": "d1_l2_q1", "type": "mc", "prompt": "A quest requires you to collect 8 flowers and 9 mushrooms. Which equation shows the total number of items you need?", "visual": "", "data": { "options": ["9 - 8 = 1", "8 + 9 = 17", "8 + 8 = 16"] }, "correct": "8 + 9 = 17" },
                { "id": "d1_l2_q2", "type": "mc", "prompt": "A griffin flew 12 miles, then rested. Then it flew 6 more miles. What is the total distance it flew?", "visual": "", "data": { "options": ["6 miles", "18 miles", "20 miles"] }, "correct": "18 miles" },
                { "id": "d1_l2_q3", "type": "mc", "prompt": "In the enchanted forest, there are 9 unicorns and 7 pegasi. Which group is smaller?", "visual": "", "data": { "options": ["Unicorns", "Pegasi", "They are equal"] }, "correct": "Pegasi" },
                { "id": "d1_l2_q4", "type": "mc", "prompt": "A hero earns 13 XP for defeating a goblin and 5 XP for finding a secret path. How much XP was earned in total?", "visual": "", "data": { "options": ["8 XP", "17 XP", "18 XP"] }, "correct": "18 XP" },
                { "id": "d1_l2_q5", "type": "mc", "prompt": "Which story matches the equation 11 + 8 = 19?", "visual": "", "data": { "options": ["You had 19 gems and lost 8.", "You had 11 gems and found 8 more.", "You had 11 gems and lost 8."] }, "correct": "You had 11 gems and found 8 more." },
                { "id": "d1_l2_q6", "type": "multi-select", "prompt": "Select all stories that would be solved with addition.", "visual": "", "data": { "options": ["You have 8 coins and find 8 more.", "You have 15 arrows and shoot 6.", "There are 7 elves and 9 dwarves.", "A dragon loses 5 scales."] }, "correct": ["You have 8 coins and find 8 more.", "There are 7 elves and 9 dwarves."] },
                { "id": "d1_l2_q7", "type": "multi-select", "prompt": "A hero has 14 potions. Which two groups of potions could she have?", "visual": "", "data": { "options": ["7 healing and 7 mana", "8 healing and 5 mana", "9 healing and 5 mana", "10 healing and 4 mana"] }, "correct": ["7 healing and 7 mana", "10 healing and 4 mana"] },
                { "id": "d1_l2_q8", "type": "multi-select", "prompt": "The total is 16. Select all pairs of parts that make 16.", "visual": "", "data": { "options": ["9 and 7", "8 and 8", "10 and 5", "11 and 5"] }, "correct": ["9 and 7", "8 and 8", "11 and 5"] },
                { "id": "d1_l2_q9", "type": "multi-select", "prompt": "Which keywords tell you to add?", "visual": "", "data": { "options": ["in all", "left", "more", "gave away"] }, "correct": ["in all", "more"] },
                { "id": "d1_l2_q10", "type": "multi-select", "prompt": "Select all equations that are true.", "visual": "", "data": { "options": ["8 + 8 = 16", "9 + 5 = 15", "7 + 6 = 13", "12 + 4 = 15"] }, "correct": ["8 + 8 = 16", "7 + 6 = 13"] },
                { "id": "d1_l2_q11", "type": "text-box", "prompt": "A wizard has 9 red spellbooks and 6 blue spellbooks. How many spellbooks does he have in all?", "visual": "", "data": { "size": 2 }, "correct": "15" },
                { "id": "d1_l2_q12", "type": "text-box", "prompt": "You need 18 logs to build a bridge. You have 9. How many more do you need to find?", "visual": "", "data": { "size": 2 }, "correct": "9" },
                { "id": "d1_l2_q13", "type": "text-box", "prompt": "A quest has two parts. The first part gives 11 XP. The second part gives 9 XP. What is the total XP for the quest?", "visual": "", "data": { "size": 2 }, "correct": "20" },
                { "id": "d1_l2_q14", "type": "text-box", "prompt": "Write the equation for this story: There are 8 knights. 7 more join them.", "visual": "", "data": { "size": 10 }, "correct": "8 + 7 = 15" },
                { "id": "d1_l2_q15", "type": "text-box", "prompt": "A dragon's hoard has 13 gold bars and 6 silver bars. How many bars are there in total?", "visual": "", "data": { "size": 2 }, "correct": "19" },
                { "id": "d1_l2_q16", "type": "drag-drop-sort", "prompt": "Sort the quests by the operation you would use to solve them.", "visual": "", "data": { "items": ["6 gems and 5 more", "12 coins, 4 are lost", "8 griffins, 9 join", "15 potions, 7 are used"], "categories": ["Addition", "Subtraction"] }, "correct": { "Addition": ["6 gems and 5 more", "8 griffins, 9 join"], "Subtraction": ["12 coins, 4 are lost", "15 potions, 7 are used"] } },
                { "id": "d1_l2_q17", "type": "drag-drop-sort", "prompt": "Sort the treasures into two chests that both have a total value of 15.", "visual": "", "data": { "items": ["8 gold", "7 gold", "9 gold", "6 gold"], "categories": ["Chest 1", "Chest 2"] }, "correct": { "Chest 1": ["8 gold", "7 gold"], "Chest 2": ["9 gold", "6 gold"] } },
                { "id": "d1_l2_q18", "type": "drag-drop-sort", "prompt": "Sort the equations by their sum.", "visual": "", "data": { "items": ["9 + 9", "10 + 7", "8 + 9", "12 + 6"], "categories": ["Sum is 17", "Sum is 18"] }, "correct": { "Sum is 17": ["10 + 7", "8 + 9"], "Sum is 18": ["9 + 9", "12 + 6"] } },
                { "id": "d1_l2_q19", "type": "drag-drop-sort", "prompt": "Sort the heroes into two parties of 13.", "visual": "", "data": { "items": ["6 warriors", "7 mages", "8 archers", "5 rogues"], "categories": ["Party 1", "Party 2"] }, "correct": { "Party 1": ["6 warriors", "7 mages"], "Party 2": ["8 archers", "5 rogues"] } },
                { "id": "d1_l2_q20", "type": "drag-drop-sort", "prompt": "Sort the keywords for the quests.", "visual": "", "data": { "items": ["in all", "join", "how many more", "total"], "categories": ["Add-To Words", "Comparison Words"] }, "correct": { "Add-To Words": ["in all", "join", "total"], "Comparison Words": ["how many more"] } }
              ],
              "level3": [
                { "id": "d1_l3_q1", "type": "mc", "prompt": "A hero has 8 arrows. He buys 5 more from a shop, and finds 4 in a chest. How many arrows does he have now?", "visual": "", "data": { "options": ["12", "13", "17"] }, "correct": "17" },
                { "id": "d1_l3_q2", "type": "mc", "prompt": "A quest requires 20 wolf pelts. You have 11. Your friend gives you 8. Do you have enough?", "visual": "", "data": { "options": ["Yes, you have 19.", "No, you have 19.", "Yes, you have 20."] }, "correct": "No, you have 19." },
                { "id": "d1_l3_q3", "type": "mc", "prompt": "A potion needs 7 toadstools and 8 spider legs. There are also 3 bat wings on the table. How many total potion ingredients are needed?", "visual": "", "data": { "options": ["15", "18", "10"] }, "correct": "15" },
                { "id": "d1_l3_q4", "type": "mc", "prompt": "I am a number. If you add 6 to me, the answer is 14. What number am I?", "visual": "", "data": { "options": ["8", "9", "20"] }, "correct": "8" },
                { "id": "d1_l3_q5", "type": "mc", "prompt": "Which has a greater sum? A party of 9 dwarves and 9 elves, or a party of 10 humans and 7 halflings?", "visual": "", "data": { "options": ["9 + 9 is greater", "10 + 7 is greater", "They are equal"] }, "correct": "9 + 9 is greater" },
                { "id": "d1_l3_q6", "type": "text-box", "prompt": "A hero starts with 5 coins. He earns 8 on a quest, then finds 5 more. How many coins does he have?", "visual": "", "data": { "size": 2 }, "correct": "18" },
                { "id": "d1_l3_q7", "type": "text-box", "prompt": "Write your own 'add-to' quest with three parts that equal 20. Then, write the answer.", "visual": "", "data": { "size": 50 }, "correct": "20" },
                { "id": "d1_l3_q8", "type": "text-box", "prompt": "A castle has 6 archer towers and 5 guard towers. They build 7 more towers. How many towers in all?", "visual": "", "data": { "size": 2 }, "correct": "18" },
                { "id": "d1_l3_q9", "type": "text-box", "prompt": "The sum of two numbers is 19. One number is 9. What is the other number?", "visual": "", "data": { "size": 2 }, "correct": "10" },
                { "id": "d1_l3_q10", "type": "text-box", "prompt": "A dragon's age is 11 + 8. A griffin's age is 9 + 9. Who is older? Type 'dragon' or 'griffin'.", "visual": "", "data": { "size": 10 }, "correct": "dragon" },
                { "id": "d1_l3_q11", "type": "drag-drop-match", "prompt": "Match the two-step quest to its final answer.", "visual": "", "data": { "draggables": ["Start with 5, add 6, add 7", "Start with 8, add 2, add 9"], "dropTargets": ["19", "18"] }, "correct": { "Start with 5, add 6, add 7": "18", "Start with 8, add 2, add 9": "19" } },
                { "id": "d1_l3_q12", "type": "drag-drop-sort", "prompt": "Put the events in order to make a story for 8 + 6 = 14.", "visual": "", "data": { "items": ["The hero has 14 gems.", "A gnome gives him 6 more.", "A hero starts with 8 gems."], "categories": ["First", "Second", "Third"] }, "correct": { "First": ["A hero starts with 8 gems."], "Second": ["A gnome gives him 6 more."], "Third": ["The hero has 14 gems."] } },
                { "id": "d1_l3_q13", "type": "drag-drop-match", "prompt": "Match the total to the correct group of items.", "visual": "", "data": { "draggables": ["17", "16"], "dropTargets": ["8 potions and 8 potions", "9 swords and 8 swords"] }, "correct": { "17": "9 swords and 8 swords", "16": "8 potions and 8 potions" } },
                { "id": "d1_l3_q14", "type": "drag-drop-sort", "prompt": "Create an equation that equals 20.", "visual": "", "data": { "items": ["11", "9", "+", "="], "categories": ["Part 1", "Sign", "Part 2", "Equals", "Whole"] }, "correct": { "Part 1": ["11"], "Sign": ["+"], "Part 2": ["9"], "Equals": ["="], "Whole": [] } },
                { "id": "d1_l3_q15", "type": "drag-drop-match", "prompt": "Match the answer to the quest that has unimportant information.", "visual": "", "data": { "draggables": ["A hero has 7 swords and 4 shields. He gets 8 more swords.", "A hero has 10 gold and 5 silver. He finds 6 more gold."], "dropTargets": ["16 gold", "15 swords"] }, "correct": { "A hero has 7 swords and 4 shields. He gets 8 more swords.": "15 swords", "A hero has 10 gold and 5 silver. He finds 6 more gold.": "16 gold" } },
                { "id": "d1_l3_q16", "type": "mc", "prompt": "Part A: A wizard has 8 fire spells and 5 ice spells. How many spells in total? Part B: If he learns 4 more spells, how many does he have now?", "visual": "", "data": { "options": ["A: 13, B: 17", "A: 13, B: 18", "A: 12, B: 16"] }, "correct": "A: 13, B: 17" },
                { "id": "d1_l3_q17", "type": "mc", "prompt": "Part A: You need 18 ingredients for a potion. You have 9. How many more do you need? Part B: If you find 5 more, do you have enough?", "visual": "", "data": { "options": ["A: 9, B: No", "A: 9, B: Yes", "A: 8, B: No"] }, "correct": "A: 9, B: No" },
                { "id": "d1_l3_q18", "type": "mc", "prompt": "Part A: A party has 6 elves and 7 dwarves. How many heroes? Part B: If 5 more heroes join, how many are in the party now?", "visual": "", "data": { "options": ["A: 13, B: 18", "A: 12, B: 17", "A: 13, B: 19"] }, "correct": "A: 13, B: 18" },
                { "id": "d1_l3_q19", "type": "mc", "prompt": "Part A: A dragon eats 8 sheep and 8 cows. How many animals did it eat? Part B: Is the answer an even or odd number?", "visual": "", "data": { "options": ["A: 16, B: Even", "A: 16, B: Odd", "A: 17, B: Odd"] }, "correct": "A: 16, B: Even" },
                { "id": "d1_l3_q20", "type": "mc", "prompt": "Part A: Solve 9 + 5. Part B: Which story matches this equation?", "visual": "", "data": { "options": ["A: 14, B: You have 9 coins and find 5 more.", "A: 14, B: You have 9 coins and lose 5.", "A: 13, B: You have 9 coins and find 5 more."] }, "correct": "A: 14, B: You have 9 coins and find 5 more." }
              ]
            }
          },
          "day2": {
            "title": "The Goblin's Toll (Take-From Problems)",
            "standard": "2.PAFR.1.3 - Solve one-step add-to, take-from, and part-part-whole real-world situations.",
            "sections": {
              "hook": [
                { "id": "d2_hook_1", "type": "content", "prompt": "Our party has a treasure chest with 15 gold coins. To cross the bridge, a grumpy goblin demands a toll of 4 coins. How many coins are left for our adventure?" }
              ],
              "i_do": [
                { "id": "d2_ido_1", "type": "mc", "prompt": "A dragon had 18 shiny scales. 5 scales fell off. How many scales are left?", "visual": "part_part_whole_mat: {whole:{type:'scale', count:18}, part1:{type:'scale', count:5}, part2:'?'}", "data": { "options": ["12", "13", "14"] }, "correct": "13" },
                { "id": "d2_ido_2", "type": "text-box", "prompt": "A hero started with 20 arrows. She used 7 in a battle. How many arrows does she have now?", "visual": "equation_scroll: {text:'20 - 7 = ?'}", "data": { "size": 2 }, "correct": "13" },
                { "id": "d2_ido_3", "type": "true-false", "prompt": "You have 15 gold coins and pay a 6-coin toll. The correct equation is 15 - 6 = 9.", "visual": "", "data": { "options": ["True", "False"] }, "correct": "True" }
              ],
              "we_do": [
                { "id": "d2_wedo_1", "type": "mc", "prompt": "A knight had 14 swords. He gave 6 to his squires. How many swords does the knight have now?", "visual": "", "data": { "options": ["7", "8", "9"] }, "correct": "8" },
                { "id": "d2_wedo_2", "type": "mc", "prompt": "You have 17 potions. You drink 5. How many are left?", "visual": "part_part_whole_mat: {whole:{type:'potion', count:17}, part1:{type:'potion', count:5}, part2:'?'}", "data": { "options": ["11", "12", "13"] }, "correct": "12" },
                { "id": "d2_wedo_3", "type": "true-false", "prompt": "18 gems minus 9 gems equals 10 gems.", "visual": "", "data": { "options": ["True", "False"] }, "correct": "False" },
                { "id": "d2_wedo_4", "type": "text-box", "prompt": "A wizard had 19 spell scrolls. He used 8 of them. How many scrolls are left?", "visual": "", "data": { "size": 2 }, "correct": "11" },
                { "id": "d2_wedo_5", "type": "drag-drop-match", "prompt": "Drag the answer to the quest scroll.", "visual": "equation_scroll: {text:'16 - 7 = ?'}", "data": { "draggables": ["9", "10"], "dropTargets": ["Answer"] }, "correct": { "9": "Answer" } },
                { "id": "d2_wedo_6", "type": "mc", "prompt": "An army of 20 soldiers went to battle. 9 soldiers were sent to guard the castle. How many went to battle?", "visual": "", "data": { "options": ["11", "12", "13"] }, "correct": "11" },
                { "id": "d2_wedo_7", "type": "true-false", "prompt": "You have 13 gold pieces and spend 4. You have 9 left.", "visual": "", "data": { "options": ["True", "False"] }, "correct": "True" },
                { "id": "d2_wedo_8", "type": "text-box", "prompt": "Solve: A dragon had 15 gems in its hoard. A thief stole 8. How many are left?", "visual": "", "data": { "size": 2 }, "correct": "7" },
                { "id": "d2_wedo_9", "type": "mc", "prompt": "Which scroll matches the story: 'You have 14 potions and use 5.'?", "visual": "", "data": { "options": ["14 + 5 = 19", "14 - 5 = 9", "19 - 5 = 14"] }, "correct": "14 - 5 = 9" },
                { "id": "d2_wedo_10", "type": "drag-drop-match", "prompt": "A hero has 12 arrows and shoots 7. Drag the remaining arrows to the 'Part 2' box.", "visual": "part_part_whole_mat: {whole:12, part1:7, part2:'?'}", "data": { "draggables": ["5 Arrows", "6 Arrows"], "dropTargets": ["Part 2"] }, "correct": { "5 Arrows": "Part 2" } }
              ],
              "you_do": [
                { "id": "d2_youdo_1", "type": "mc", "prompt": "You had 16 berries. You ate 9 of them. How many are left?", "visual": "", "data": { "options": ["7", "8", "9"] }, "correct": "7" },
                { "id": "d2_youdo_2", "type": "text-box", "prompt": "A castle has 18 flags. A storm rips 6 of them. How many flags are left?", "visual": "", "data": { "size": 2 }, "correct": "12" },
                { "id": "d2_youdo_3", "type": "true-false", "prompt": "A wizard knew 20 spells. He forgot 5. He still knows 15 spells.", "visual": "", "data": { "options": ["True", "False"] }, "correct": "True" },
                { "id": "d2_youdo_4", "type": "mc", "prompt": "A quest requires 15 herbs. You used 7. How many do you have left?", "visual": "", "data": { "options": ["7", "8", "9"] }, "correct": "8" },
                { "id": "d2_youdo_5", "type": "drag-drop-match", "prompt": "Drag the answer to the equation: 19 - 9 = ?", "visual": "", "data": { "draggables": ["10", "11"], "dropTargets": ["Equation"] }, "correct": { "10": "Equation" } }
              ]
            },
            "practice_center": { "level1": [], "level2": [], "level3": [] }
          },
          "day3": {
            "title": "The Dragon's Hoard (Part-Part-Whole Problems)",
            "standard": "2.PAFR.1.3 - Solve one-step add-to, take-from, and part-part-whole real-world situations.",
            "sections": {
              "hook": [
                { "id": "d3_hook_1", "type": "content", "prompt": "A dragon's treasure chest has 16 total gems. 9 of them are rubies. How can we find out how many are sapphires?" }
              ],
              "i_do": [
                { "id": "d3_ido_1", "type": "mc", "prompt": "A knight has 8 steel shields and 5 wooden shields. How many shields in total?", "visual": "part_part_whole_mat: {part1:{type:'shield', count:8}, part2:{type:'shield', count:5}, whole:'?'}", "data": { "options": ["12", "13", "14"] }, "correct": "13" },
                { "id": "d3_ido_2", "type": "text-box", "prompt": "A wizard has 14 potions. 6 are healing potions, and the rest are mana potions. How many are mana potions?", "visual": "part_part_whole_mat: {whole:14, part1:{type:'potion', count:6}, part2:'?'}", "data": { "size": 2 }, "correct": "8" },
                { "id": "d3_ido_3", "type": "true-false", "prompt": "If a chest has 17 total coins and 9 are gold, then there must be 8 silver coins.", "visual": "", "data": { "options": ["True", "False"] }, "correct": "True" }
              ],
              "we_do": [
                { "id": "d3_wedo_1", "type": "mc", "prompt": "There are 17 adventurers in a dungeon. 9 are warriors and the rest are mages. How many are mages?", "visual": "", "data": { "options": ["7", "8", "9"] }, "correct": "8" },
                { "id": "d3_wedo_2", "type": "mc", "prompt": "A treasure map has two parts. The first part is 7 miles long. The second part is 9 miles long. How long is the whole journey?", "visual": "", "data": { "options": ["15 miles", "16 miles", "17 miles"] }, "correct": "16 miles" },
                { "id": "d3_wedo_3", "type": "true-false", "prompt": "If there are 11 heroes total and 5 are elves, then 7 must be dwarves.", "visual": "", "data": { "options": ["True", "False"] }, "correct": "False" },
                { "id": "d3_wedo_4", "type": "text-box", "prompt": "A dragon's hoard has 18 items. 10 are gold coins and the rest are gems. How many are gems?", "visual": "", "data": { "size": 2 }, "correct": "8" },
                { "id": "d3_wedo_5", "type": "drag-drop-match", "prompt": "Drag the missing part to the equation scroll.", "visual": "equation_scroll: {text:'8 + ? = 15'}", "data": { "draggables": ["7", "8"], "dropTargets": ["?"] }, "correct": { "7": "?" } },
                { "id": "d3_wedo_6", "type": "mc", "prompt": "A forest has 13 talking animals. 6 are squirrels and the rest are rabbits. How many are rabbits?", "visual": "", "data": { "options": ["6", "7", "8"] }, "correct": "7" },
                { "id": "d3_wedo_7", "type": "true-false", "prompt": "A chest with 9 rubies and 9 sapphires has 18 gems in total.", "visual": "", "data": { "options": ["True", "False"] }, "correct": "True" },
                { "id": "d3_wedo_8", "type": "text-box", "prompt": "A hero needs 20 arrows. She has 11. How many more does she need to make?", "visual": "", "data": { "size": 2 }, "correct": "9" },
                { "id": "d3_wedo_9", "type": "mc", "prompt": "Which story matches '14 - 6 = 8'?", "visual": "", "data": { "options": ["You have 14 coins and find 6 more.", "You have 14 coins. 6 are gold and 8 are silver.", "You have 8 coins and find 6 more."] }, "correct": "You have 14 coins. 6 are gold and 8 are silver." },
                { "id": "d3_wedo_10", "type": "drag-drop-match", "prompt": "A hoard has 17 gems total. One part is 8 gems. Drag the other part to the mat.", "visual": "part_part_whole_mat: {whole:17, part1:8, part2:'?'}", "data": { "draggables": ["8 gems", "9 gems"], "dropTargets": ["Part 2"] }, "correct": { "9 gems": "Part 2" } }
              ],
              "you_do": [
                { "id": "d3_youdo_1", "type": "mc", "prompt": "A library has 19 spellbooks. 12 are on a shelf and the rest are on a table. How many are on the table?", "visual": "", "data": { "options": ["6", "7", "8"] }, "correct": "7" },
                { "id": "d3_youdo_2", "type": "text-box", "prompt": "A blacksmith has 9 iron swords and 7 steel swords. How many swords does he have in all?", "visual": "", "data": { "size": 2 }, "correct": "16" },
                { "id": "d3_youdo_3", "type": "true-false", "prompt": "If a quest has a total of 15 XP and you've earned 8 XP, you still need to earn 7 XP.", "visual": "", "data": { "options": ["True", "False"] }, "correct": "True" },
                { "id": "d3_youdo_4", "type": "mc", "prompt": "A potion requires 13 total ingredients. You have 6. How many more do you need?", "visual": "", "data": { "options": ["7", "8", "9"] }, "correct": "7" },
                { "id": "d3_youdo_5", "type": "drag-drop-match", "prompt": "Drag the missing part to the equation: ? + 5 = 11", "visual": "", "data": { "draggables": ["6", "7"], "dropTargets": ["?"] }, "correct": { "6": "?" } }
              ]
            },
            "practice_center": { "level1": [], "level2": [], "level3": [] }
          },
          "day4": {
            "title": "The Mystery of the Missing Rune (Unknown in Any Position)",
            "standard": "2.PAFR.1.7 - Determine the unknown number in addition and subtraction equations within 20, with the unknown in any position.",
            "sections": {
              "hook": [
                { "id": "d4_hook_1", "type": "content", "prompt": "Heroes, we've found an ancient altar with a magical equation: 8 + ? = 13. The '?' is a missing rune! What number must it be to unlock the altar's power?" }
              ],
              "i_do": [
                { "id": "d4_ido_1", "type": "mc", "prompt": "A wizard has some potions. He brews 7 more and now has 15. How many did he start with? (? + 7 = 15)", "visual": "part_part_whole_mat: {whole:15, part1:'?', part2:{type:'potion', count:7}}", "data": { "options": ["7", "8", "9"] }, "correct": "8" },
                { "id": "d4_ido_2", "type": "text-box", "prompt": "A knight had 18 shields. After a battle, he has 10 left. How many shields were broken? (18 - ? = 10)", "visual": "equation_scroll: {text:'18 - ? = 10'}", "data": { "size": 2 }, "correct": "8" },
                { "id": "d4_ido_3", "type": "true-false", "prompt": "To solve ? - 5 = 12, you can add 12 + 5.", "visual": "", "data": { "options": ["True", "False"] }, "correct": "True" }
              ],
              "we_do": [
                { "id": "d4_wedo_1", "type": "mc", "prompt": "Find the missing rune: 16 - ? = 9.", "visual": "", "data": { "options": ["6", "7", "8"] }, "correct": "7" },
                { "id": "d4_wedo_2", "type": "mc", "prompt": "A party of heroes had some members. 5 more joined, and now there are 13. How many heroes were there at the start? (? + 5 = 13)", "visual": "", "data": { "options": ["7", "8", "9"] }, "correct": "8" },
                { "id": "d4_wedo_3", "type": "true-false", "prompt": "The missing number in 7 + ? = 15 is 9.", "visual": "", "data": { "options": ["True", "False"] }, "correct": "False" },
                { "id": "d4_wedo_4", "type": "text-box", "prompt": "A dragon had some gold. After giving away 8 coins, it had 11 left. How much gold did it start with? (? - 8 = 11)", "visual": "", "data": { "size": 2 }, "correct": "19" },
                { "id": "d4_wedo_5", "type": "drag-drop-match", "prompt": "Drag the missing rune to the equation.", "visual": "equation_scroll: {text:'? + 9 = 17'}", "data": { "draggables": ["7", "8"], "dropTargets": ["?"] }, "correct": { "8": "?" } },
                { "id": "d4_wedo_6", "type": "mc", "prompt": "Solve: 19 - ? = 11.", "visual": "", "data": { "options": ["7", "8", "9"] }, "correct": "8" },
                { "id": "d4_wedo_7", "type": "true-false", "prompt": "To solve 14 - ? = 6, you can solve 14 - 6.", "visual": "", "data": { "options": ["True", "False"] }, "correct": "True" },
                { "id": "d4_wedo_8", "type": "text-box", "prompt": "A blacksmith needs 20 iron bars. He has some, and then finds 9 more to complete his task. How many did he have to start?", "visual": "", "data": { "size": 2 }, "correct": "11" },
                { "id": "d4_wedo_9", "type": "mc", "prompt": "Which story matches '? - 6 = 13'?", "visual": "", "data": { "options": ["You had 13 coins and lost 6.", "You had some coins, lost 6, and now have 13.", "You had 6 coins and found some more to make 13."] }, "correct": "You had some coins, lost 6, and now have 13." },
                { "id": "d4_wedo_10", "type": "drag-drop-match", "prompt": "Drag the whole to the mat to solve ? - 7 = 8.", "visual": "part_part_whole_mat: {whole:'?', part1:7, part2:8}", "data": { "draggables": ["15", "16"], "dropTargets": ["Whole"] }, "correct": { "15": "Whole" } }
              ],
              "you_do": [
                { "id": "d4_youdo_1", "type": "mc", "prompt": "Solve: 8 + ? = 17", "visual": "", "data": { "options": ["8", "9", "10"] }, "correct": "9" },
                { "id": "d4_youdo_2", "type": "text-box", "prompt": "You had some potions. You used 9 and have 9 left. How many did you start with?", "visual": "", "data": { "size": 2 }, "correct": "18" },
                { "id": "d4_youdo_3", "type": "true-false", "prompt": "The missing number in 16 - ? = 7 is 9.", "visual": "", "data": { "options": ["True", "False"] }, "correct": "True" },
                { "id": "d4_youdo_4", "type": "mc", "prompt": "A wizard has 11 spellbooks. He needs a total of 20 for his library. How many more does he need to buy?", "visual": "", "data": { "options": ["8", "9", "10"] }, "correct": "9" },
                { "id": "d4_youdo_5", "type": "drag-drop-match", "prompt": "Drag the missing number to the equation: ? + 11 = 19", "visual": "", "data": { "draggables": ["7", "8"], "dropTargets": ["?"] }, "correct": { "8": "?" } }
              ]
            },
            "practice_center": { "level1": [], "level2": [], "level3": [] }
          }
        };

        // --- STATE MANAGEMENT ---
        let appState = {
            activeDay: 'day1',
            currentMode: 'lesson', // 'lesson' or 'practice'
            progress: {},
            practiceLevel: 'level1',
            correctStreak: 0
        };

        const POSITIVE_FEEDBACK = ["Huzzah!", "A legendary success!", "Your wisdom grows!", "Quest Complete!", "Victory!"];

        // --- SVG & DYNAMIC ELEMENT GENERATION ---

        const createSvgElement = (tag, attrs) => {
            const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
            for (let key in attrs) {
                el.setAttribute(key, attrs[key]);
            }
            return el;
        };
        
        const generateVisual = (visualString) => {
            if (!visualString) return null;

            const svg = createSvgElement('svg', { viewBox: '0 0 400 200', class: 'w-full h-auto max-w-lg mx-auto' });
            
            const [type, paramsStr] = visualString.split(/:(.+)/);
            let params = {};
            if (paramsStr) {
                try {
                    params = new Function(`return ${paramsStr}`)();
                } catch (e) {
                    console.error("Could not parse visual params:", paramsStr, e);
                    return null;
                }
            }
            
            const getItemEmoji = (type) => {
                const map = { 'potion': 'üß™', 'arrow': 'üèπ', 'shield': 'üõ°Ô∏è', 'gold_coin': 'üí∞', 'ruby': 'üíé', 'sapphire': 'üí†', 'scale': 'üêâ' };
                return map[type] || '‚ùì';
            };

            switch (type.trim()) {
                case 'part_part_whole_mat':
                    const { part1, part2, whole } = params;
                    const matGroup = createSvgElement('g');
                    // Whole Box
                    matGroup.appendChild(createSvgElement('rect', { x: 50, y: 20, width: 300, height: 70, rx:10, fill: 'rgba(122, 92, 79, 0.1)', stroke: '#7a5c4f', 'stroke-width': 2 }));
                    // Part Boxes
                    matGroup.appendChild(createSvgElement('rect', { x: 50, y: 110, width: 140, height: 70, rx:10, fill: 'rgba(122, 92, 79, 0.1)', stroke: '#7a5c4f', 'stroke-width': 2 }));
                    matGroup.appendChild(createSvgElement('rect', { x: 210, y: 110, width: 140, height: 70, rx:10, fill: 'rgba(122, 92, 79, 0.1)', stroke: '#7a5c4f', 'stroke-width': 2 }));

                    const renderContent = (content, x, y) => {
                        if (typeof content === 'string' || typeof content === 'number') {
                            const text = createSvgElement('text', { x, y, 'font-size': '40px', 'font-family': 'MedievalSharp', fill: '#3a2c23', 'text-anchor': 'middle' });
                            text.textContent = content;
                            return text;
                        }
                        if (typeof content === 'object') {
                            const itemText = createSvgElement('text', { x, y, 'font-size': '24px', 'text-anchor': 'middle' });
                            itemText.textContent = `${getItemEmoji(content.type)} x ${content.count}`;
                            return itemText;
                        }
                        return null;
                    };
                    
                    matGroup.appendChild(renderContent(whole, 200, 65));
                    matGroup.appendChild(renderContent(part1, 120, 155));
                    matGroup.appendChild(renderContent(part2, 280, 155));

                    svg.appendChild(matGroup);
                    break;
                case 'equation_scroll':
                     svg.setAttribute('viewBox', '0 0 300 100');
                    const scrollText = createSvgElement('text', { x: 150, y: 58, 'font-size': '28px', 'font-family': 'MedievalSharp', fill: '#3a2c23', 'text-anchor': 'middle' });
                    scrollText.textContent = params.text;
                    svg.appendChild(scrollText);
                    break;
                case 'item_counter':
                    svg.setAttribute('viewBox', '0 0 200 100');
                    const itemGroup = createSvgElement('g');
                    const itemEmoji = createSvgElement('text', { x: 100, y: 60, 'font-size': '40px', 'text-anchor': 'middle' });
                    itemEmoji.textContent = `${getItemEmoji(params.type)} x ${params.count}`;
                    itemGroup.appendChild(itemEmoji);
                    svg.appendChild(itemGroup);
                    break;
            }
            return svg;
        };

        // --- APPLICATION LOGIC ---
        const init = () => {
            loadProgress();
            renderTabs();
            renderDay(appState.activeDay);
            setupEventListeners();
        };

        const renderTabs = () => {
            const tabsContainer = document.getElementById('main-tabs');
            tabsContainer.innerHTML = '';
            Object.keys(lessonData).forEach(dayKey => {
                const dayNum = dayKey.replace('day', '');
                const button = document.createElement('button');
                button.className = `tab-btn ${appState.activeDay === dayKey ? 'active' : ''}`;
                button.textContent = `Day ${dayNum}`;
                button.dataset.day = dayKey;
                tabsContainer.appendChild(button);
            });
        };

        const renderDay = (dayKey) => {
            const dayData = lessonData[dayKey];
            const contentArea = document.getElementById('content-area');
            
            if (!appState.progress[dayKey]) {
                appState.progress[dayKey] = {
                    lesson: { slideIndex: 0, answers: {} },
                    practice: { slideIndex: 0, answers: {} }
                };
            }

            contentArea.innerHTML = `
                <div class="day-container" data-day="${dayKey}">
                    <div class="flex justify-between items-center mb-4 p-4">
                        <button class="mode-toggle-btn rpg-btn" data-mode="${appState.currentMode === 'lesson' ? 'practice' : 'lesson'}">
                            ${appState.currentMode === 'lesson' ? 'To the Dungeons! ‚öîÔ∏è' : 'Back to Camp üèïÔ∏è'}
                        </button>
                        <div id="streak-counter" class="text-2xl rpg-font text-amber-400 ${appState.currentMode === 'practice' ? '' : 'hidden'}">
                            XP Multiplier: x${1 + Math.floor(appState.correctStreak / 3)}
                        </div>
                    </div>
                    <div id="lesson-view" class="${appState.currentMode === 'lesson' ? '' : 'hidden'}"></div>
                    <div id="practice-view" class="${appState.currentMode === 'practice' ? '' : 'hidden'}"></div>
                </div>
            `;
            
            if (appState.currentMode === 'lesson') {
                renderLessonView(dayKey);
            } else {
                renderPracticeView(dayKey);
            }
        };
        
        const renderLessonView = (dayKey) => {
            const dayData = lessonData[dayKey];
            const lessonContainer = document.getElementById('lesson-view');
            const lessonProgress = appState.progress[dayKey].lesson;
            
            const allSlides = [].concat(...Object.values(dayData.sections));

            lessonContainer.innerHTML = `
                <h2 class="text-3xl font-bold text-center mb-2">${dayData.title}</h2>
                <p class="text-center text-lg italic mb-4">${dayData.standard}</p>
                <div id="lesson-slides-container"></div>
                <div class="flex justify-between items-center mt-4">
                    <button id="lesson-prev-btn" class="rpg-btn">‚¨ÖÔ∏è Last Page</button>
                    <div id="quest-map" class="w-1/2 h-8 bg-center bg-no-repeat bg-contain" style="background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMjAiPjxwYXRoIGQ9Ik0wIDEwIEwgMjAwIDEwIiBzdHJva2U9IiM4YTZjNWYiIHN0cm9rZS13aWR0aD0iMiIgc3Ryb2tlLWRhc2hhcnJheT0iNCA0Ii8+PC9zdmc+');">
                        <div id="hero-icon" class="w-8 h-8 transition-all duration-500" style="transform: translateX(0px);">üë£</div>
                    </div>
                    <button id="lesson-next-btn" class="rpg-btn">Next Page ‚û°Ô∏è</button>
                </div>
            `;
            
            renderSlide('lesson', dayKey, lessonProgress.slideIndex);
        };

        const renderPracticeView = (dayKey) => {
            const practiceContainer = document.getElementById('practice-view');
            const practiceProgress = appState.progress[dayKey].practice;
            const level = appState.practiceLevel;
            const questions = lessonData[dayKey].practice_center[level];

            practiceContainer.innerHTML = `
                <div class="flex justify-center items-center mb-4 space-x-4">
                    <h2 class="text-3xl font-bold">Training Dungeons</h2>
                    <select id="level-select" class="rpg-btn bg-[#4a382f]">
                        <option value="level1" ${level === 'level1' ? 'selected' : ''}>Easy</option>
                        <option value="level2" ${level === 'level2' ? 'selected' : ''}>Medium</option>
                        <option value="level3" ${level === 'level3' ? 'selected' : ''}>Hard</option>
                    </select>
                </div>
                <div id="practice-slides-container"></div>
                 <div class="flex justify-between items-center mt-4">
                    <button id="practice-prev-btn" class="rpg-btn">‚¨ÖÔ∏è Previous</button>
                    <span class="font-bold text-lg rpg-font">${practiceProgress.slideIndex + 1} / ${questions.length}</span>
                    <button id="practice-next-btn" class="rpg-btn">Next ‚û°Ô∏è</button>
                </div>
            `;
            
            renderSlide('practice', dayKey, practiceProgress.slideIndex);
        };

        const renderSlide = (mode, dayKey, slideIndex) => {
            const container = document.getElementById(`${mode}-slides-container`);
            if (!container) return;

            let slideData;
            if (mode === 'lesson') {
                const allSlides = [].concat(...Object.values(lessonData[dayKey].sections));
                slideData = allSlides[slideIndex];
            } else {
                const level = appState.practiceLevel;
                slideData = lessonData[dayKey].practice_center[level][slideIndex];
            }

            if (!slideData) return;

            const slideElement = document.createElement('div');
            slideElement.className = 'slide flex flex-col items-center justify-center text-center';
            slideElement.dataset.id = slideData.id;

            const visualElement = generateVisual(slideData.visual);
            
            slideElement.innerHTML = `
                <p class="text-2xl mb-4">${slideData.prompt}</p>
                ${visualElement ? `<div class="visual-container mb-4 w-full">${visualElement.outerHTML}</div>` : ''}
                <div class="interactive-area w-full max-w-2xl"></div>
                <div class="feedback-area mt-4 w-full max-w-2xl relative"></div>
            `;

            container.innerHTML = '';
            container.appendChild(slideElement);
            
            renderInteractiveElement(slideElement, slideData);

            const savedAnswer = appState.progress[dayKey][mode].answers[slideData.id];
            if (savedAnswer) {
                restoreAnswer(slideElement, slideData.type, savedAnswer);
                handleCheckAnswer({ target: slideElement.querySelector('.check-answer-btn') });
            }
            
            if (mode === 'lesson') {
                const allLessonSlides = [].concat(...Object.values(lessonData[dayKey].sections));
                if (slideIndex === allLessonSlides.length - 1) {
                    const btn = document.createElement('button');
                    btn.textContent = 'Enter the Dungeons! ‚öîÔ∏è';
                    btn.className = 'rpg-btn text-2xl mt-8 mode-toggle-btn';
                    btn.dataset.mode = 'practice';
                    slideElement.querySelector('.interactive-area').appendChild(btn);
                }
            }
            
            updateNavButtons(mode, dayKey);
        };

        const renderInteractiveElement = (slideElement, question) => {
            const container = slideElement.querySelector('.interactive-area');
            switch (question.type) {
                case 'mc':
                case 'multi-select':
                case 'true-false':
                    const optionsContainer = document.createElement('div');
                    optionsContainer.className = 'flex flex-wrap justify-center gap-4';
                    question.data.options.forEach(option => {
                        const button = document.createElement('button');
                        button.className = 'rpg-btn';
                        button.textContent = option;
                        button.dataset.option = option;
                        optionsContainer.appendChild(button);
                    });
                    container.appendChild(optionsContainer);
                    break;
                case 'text-box':
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.maxLength = question.data.size;
                    input.className = 'p-2 bg-[#f3e9dc] border-2 border-[#8a6c5f] rounded-lg text-2xl text-center text-[#3a2c23] w-full md:w-1/2';
                    container.appendChild(input);
                    break;
                case 'drag-drop-match':
                case 'drag-drop-sort':
                    initDragAndDrop(slideElement, question);
                    break;
            }

            if (question.type !== 'content') {
                 const checkButton = document.createElement('button');
                 checkButton.textContent = 'Check Answer';
                 checkButton.className = 'rpg-btn check-answer-btn mt-6';
                 container.appendChild(checkButton);
            }
        };
        
        function initDragAndDrop(slideElement, question) {
            const interactiveArea = slideElement.querySelector('.interactive-area');
            interactiveArea.innerHTML = ''; // Clear for DD setup

            if (question.type === 'drag-drop-match') {
                const container = document.createElement('div');
                container.className = 'flex flex-col md:flex-row items-center justify-center gap-8';
                
                const draggablesContainer = document.createElement('div');
                draggablesContainer.className = 'flex flex-col gap-4';
                question.data.draggables.forEach(item => {
                    const el = document.createElement('div');
                    el.className = 'rpg-btn draggable p-4';
                    el.textContent = item;
                    el.draggable = true;
                    el.dataset.value = item;
                    draggablesContainer.appendChild(el);
                });

                const dropTargetsContainer = document.createElement('div');
                dropTargetsContainer.className = 'flex flex-col gap-4';
                question.data.dropTargets.forEach(target => {
                    const targetEl = document.createElement('div');
                    targetEl.className = 'flex items-center gap-4';
                    targetEl.innerHTML = `<div class="drop-target w-48 h-16 rounded-lg flex items-center justify-center" data-target="${target}"></div><span class="text-xl font-bold rpg-font">${target}</span>`;
                    dropTargetsContainer.appendChild(targetEl);
                });

                container.appendChild(draggablesContainer);
                container.appendChild(dropTargetsContainer);
                interactiveArea.appendChild(container);
            }
            
            let draggedItem = null;
            slideElement.querySelectorAll('.draggable').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedItem = e.target;
                    setTimeout(() => e.target.style.opacity = '0.5', 0);
                });
                item.addEventListener('dragend', (e) => {
                    draggedItem = null;
                    e.target.style.opacity = '1';
                });
            });

            slideElement.querySelectorAll('.drop-target').forEach(target => {
                target.addEventListener('dragover', (e) => { e.preventDefault(); target.classList.add('over'); });
                target.addEventListener('dragleave', () => { target.classList.remove('over'); });
                target.addEventListener('drop', (e) => {
                    e.preventDefault();
                    target.classList.remove('over');
                    if (draggedItem) {
                        if (target.children.length > 0 && question.type === 'drag-drop-match') {
                            const existingItem = target.firstElementChild;
                            draggedItem.parentElement.appendChild(existingItem);
                        }
                        target.appendChild(draggedItem);
                        saveProgress(question.id);
                    }
                });
            });
        }

        const updateNavButtons = (mode, dayKey) => {
            const progress = appState.progress[dayKey][mode];
            const prevBtn = document.getElementById(`${mode}-prev-btn`);
            const nextBtn = document.getElementById(`${mode}-next-btn`);
            
            let totalSlides;
            if (mode === 'lesson') {
                totalSlides = [].concat(...Object.values(lessonData[dayKey].sections)).length;
                const map = document.getElementById('quest-map');
                const hero = document.getElementById('hero-icon');
                if(map && hero) {
                    const mapWidth = map.offsetWidth;
                    const progressPercentage = progress.slideIndex / (totalSlides - 1);
                    hero.style.transform = `translateX(${progressPercentage * (mapWidth - 32)}px)`; // 32 is hero width
                }
            } else {
                totalSlides = lessonData[dayKey].practice_center[appState.practiceLevel].length;
            }

            prevBtn.disabled = progress.slideIndex === 0;
            nextBtn.disabled = progress.slideIndex === totalSlides - 1;
            prevBtn.style.opacity = prevBtn.disabled ? 0.5 : 1;
            nextBtn.style.opacity = nextBtn.disabled ? 0.5 : 1;
        };
        
        // --- EVENT HANDLERS ---
        const setupEventListeners = () => {
            document.getElementById('main-tabs').addEventListener('click', handleTabClick);
            document.getElementById('content-area').addEventListener('click', handleContentClick);
            document.getElementById('download-work-btn').addEventListener('click', downloadWork);
            document.getElementById('download-pdf-btn').addEventListener('click', downloadPDF);
        };
        
        const handleContentClick = (e) => {
            const target = e.target;
            
            if (target.closest('.mode-toggle-btn')) {
                appState.currentMode = target.closest('.mode-toggle-btn').dataset.mode;
                appState.correctStreak = 0;
                renderDay(appState.activeDay);
                saveProgress();
            }
            
            if (target.matches('#level-select')) {
                appState.practiceLevel = target.value;
                appState.progress[appState.activeDay].practice.slideIndex = 0;
                appState.correctStreak = 0;
                renderPracticeView(appState.activeDay);
                saveProgress();
            }

            if (target.matches('#lesson-prev-btn, #lesson-next-btn, #practice-prev-btn, #practice-next-btn')) {
                handleSlideNav(target.id);
            }
            
            if (target.closest('.interactive-area .rpg-btn') && target.closest('.interactive-area .rpg-btn').dataset.option) {
                handleOptionSelect(target.closest('.interactive-area .rpg-btn'));
            }

            if (target.closest('.check-answer-btn')) {
                handleCheckAnswer({ target: target.closest('.check-answer-btn') });
            }
        };

        const handleTabClick = (e) => {
            const dayKey = e.target.dataset.day;
            if (dayKey) {
                appState.activeDay = dayKey;
                appState.currentMode = 'lesson';
                appState.correctStreak = 0;
                renderTabs();
                renderDay(dayKey);
                saveProgress();
            }
        };

        const handleSlideNav = (buttonId) => {
            const [mode, direction] = buttonId.split('-');
            const progress = appState.progress[appState.activeDay][mode];
            
            if (direction === 'next') progress.slideIndex++;
            if (direction === 'prev') progress.slideIndex--;

            renderSlide(mode, appState.activeDay, progress.slideIndex);
            saveProgress();
        };

        const handleOptionSelect = (selectedButton) => {
            const slide = selectedButton.closest('.slide');
            const questionId = slide.dataset.id;
            const mode = document.getElementById('lesson-view').classList.contains('hidden') ? 'practice' : 'lesson';

            let question;
            if (mode === 'lesson') {
                question = [].concat(...Object.values(lessonData[appState.activeDay].sections)).find(q => q.id === questionId);
            } else {
                question = lessonData[appState.activeDay].practice_center[appState.practiceLevel].find(q => q.id === questionId);
            }

            if (question.type === 'multi-select') {
                selectedButton.classList.toggle('bg-amber-600');
            } else {
                slide.querySelectorAll('[data-option]').forEach(btn => btn.classList.remove('bg-amber-600'));
                selectedButton.classList.add('bg-amber-600');
            }
            saveProgress(questionId);
        };
        
        const handleCheckAnswer = (e) => {
            const button = e.target;
            const slide = button.closest('.slide');
            if (!slide) return;

            const questionId = slide.dataset.id;
            const mode = document.getElementById('lesson-view').classList.contains('hidden') ? 'practice' : 'lesson';
            
            let question;
            if (mode === 'lesson') {
                question = [].concat(...Object.values(lessonData[appState.activeDay].sections)).find(q => q.id === questionId);
            } else {
                question = lessonData[appState.activeDay].practice_center[appState.practiceLevel].find(q => q.id === questionId);
            }

            let userAnswer;
            let isCorrect = false;

            switch (question.type) {
                case 'mc':
                case 'true-false':
                    const selected = slide.querySelector('.bg-amber-600');
                    userAnswer = selected ? selected.dataset.option : null;
                    isCorrect = userAnswer === question.correct;
                    break;
                case 'multi-select':
                    const selectedNodes = slide.querySelectorAll('.bg-amber-600');
                    userAnswer = Array.from(selectedNodes).map(n => n.dataset.option);
                    isCorrect = question.correct.length === userAnswer.length && question.correct.every(val => userAnswer.includes(val));
                    break;
                case 'text-box':
                    const input = slide.querySelector('input[type="text"]');
                    userAnswer = input.value.trim();
                    isCorrect = userAnswer.toLowerCase() === question.correct.toLowerCase();
                    break;
                case 'drag-drop-match':
                    const matchTargets = slide.querySelectorAll('.drop-target');
                    userAnswer = {};
                    let allMatched = true;
                    matchTargets.forEach(target => {
                        const dropped = target.querySelector('.draggable');
                        if (dropped) {
                            userAnswer[dropped.dataset.value] = target.dataset.target;
                        } else {
                            allMatched = false;
                        }
                    });
                    isCorrect = allMatched && JSON.stringify(userAnswer) === JSON.stringify(question.correct);
                    break;
            }

            displayFeedback(slide, isCorrect, mode);
            
            const interactiveElements = slide.querySelectorAll('.interactive-area button, .interactive-area input, .draggable');
            interactiveElements.forEach(el => el.disabled = true);
            slide.querySelectorAll('.draggable').forEach(el => el.draggable = false);
            button.style.display = 'none';
        };

        const displayFeedback = (slide, isCorrect, mode) => {
            const feedbackArea = slide.querySelector('.feedback-area');
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = `feedback ${isCorrect ? 'correct' : 'incorrect'}`;

            if (isCorrect) {
                feedbackDiv.textContent = `üéâ ${POSITIVE_FEEDBACK[Math.floor(Math.random() * POSITIVE_FEEDBACK.length)]}`;
                if (mode === 'practice') {
                    appState.correctStreak++;
                    const xpGain = document.createElement('div');
                    const xpAmount = 10 * (1 + Math.floor((appState.correctStreak-1) / 3));
                    xpGain.textContent = `+${xpAmount} XP ‚ú®`;
                    xpGain.className = 'xp-gain';
                    feedbackArea.appendChild(xpGain);
                }
            } else {
                feedbackDiv.textContent = 'üõ°Ô∏è A valiant effort, hero! Rethink your strategy.';
                if (mode === 'practice') appState.correctStreak = 0;
            }
            feedbackArea.prepend(feedbackDiv);
            
            const streakCounter = document.getElementById('streak-counter');
            if (streakCounter) streakCounter.textContent = `XP Multiplier: x${1 + Math.floor(appState.correctStreak / 3)}`;
        };

        // --- DATA PERSISTENCE ---
        const saveProgress = (questionId = null) => {
            if (questionId) {
                const slide = document.querySelector(`[data-id="${questionId}"]`);
                if (!slide) return;
                
                const mode = document.getElementById('lesson-view').classList.contains('hidden') ? 'practice' : 'lesson';
                const dayKey = appState.activeDay;

                let question;
                if (mode === 'lesson') {
                    question = [].concat(...Object.values(lessonData[dayKey].sections)).find(q => q.id === questionId);
                } else {
                    question = lessonData[dayKey].practice_center[appState.practiceLevel].find(q => q.id === questionId);
                }

                let answer;
                switch (question.type) {
                    case 'mc':
                    case 'true-false':
                        answer = slide.querySelector('.bg-amber-600')?.dataset.option || null;
                        break;
                    case 'multi-select':
                        answer = Array.from(slide.querySelectorAll('.bg-amber-600')).map(n => n.dataset.option);
                        break;
                    case 'text-box':
                        answer = slide.querySelector('input').value;
                        break;
                    case 'drag-drop-match':
                        answer = {};
                        slide.querySelectorAll('.drop-target').forEach(target => {
                            const dropped = target.querySelector('.draggable');
                            if(dropped) answer[dropped.dataset.value] = target.dataset.target;
                        });
                        break;
                }
                appState.progress[dayKey][mode].answers[questionId] = answer;
            }
            
            localStorage.setItem('rpgWordProblemsProgress', JSON.stringify(appState));
        };

        const loadProgress = () => {
            const progressDataScript = document.getElementById('progress-data');
            let loadedState = null;

            if (progressDataScript && progressDataScript.textContent.trim().length > 2) {
                try {
                    loadedState = JSON.parse(progressDataScript.textContent);
                } catch (e) { console.error("Failed to parse embedded progress data.", e); }
            } else {
                const savedState = localStorage.getItem('rpgWordProblemsProgress');
                if (savedState) {
                    try {
                        loadedState = JSON.parse(savedState);
                    } catch (e) { console.error("Failed to parse localStorage progress data.", e); }
                }
            }

            if (loadedState) appState = loadedState;
        };

        const restoreAnswer = (slide, type, answer) => {
            if (!answer) return;
            switch (type) {
                case 'mc':
                case 'true-false':
                    slide.querySelector(`[data-option="${answer}"]`)?.classList.add('bg-amber-600');
                    break;
                case 'multi-select':
                    answer.forEach(opt => slide.querySelector(`[data-option="${opt}"]`)?.classList.add('bg-amber-600'));
                    break;
                case 'text-box':
                    slide.querySelector('input').value = answer;
                    break;
                case 'drag-drop-match':
                     Object.entries(answer).forEach(([draggableValue, targetValue]) => {
                        const draggable = slide.querySelector(`[data-value="${draggableValue}"]`);
                        const target = slide.querySelector(`[data-target="${targetValue}"]`);
                        if (draggable && target) target.appendChild(draggable);
                    });
                    break;
            }
        };

        const downloadWork = () => {
            saveProgress();
            const progressJsonString = JSON.stringify(appState);
            const updatedHtml = document.documentElement.outerHTML.replace(
                /<script id="progress-data" type="application\/json">.*?<\/script>/,
                `<script id="progress-data" type="application/json">${progressJsonString}<\/script>`
            );
            const blob = new Blob([updatedHtml], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'rpg-word-problems-progress.html';
            a.click();
            URL.revokeObjectURL(a.href);
        };
        
        const downloadPDF = async () => {
            const { jsPDF } = window.jspdf;
            const clone = document.createElement('div');
            clone.style.position = 'absolute';
            clone.style.left = '-9999px';
            clone.style.width = '1200px';
            clone.style.background = '#f3e9dc';
            clone.style.color = '#3a2c23';
            clone.style.fontFamily = 'Lato, sans-serif';
            document.body.appendChild(clone);

            for (const dayKey in lessonData) {
                const dayData = lessonData[dayKey];
                clone.innerHTML += `<h1 style="font-family: 'MedievalSharp', cursive; font-size: 24px; font-weight: bold; padding: 10px; background-color: #eaddc7; text-align: center;">Day ${dayKey.replace('day', '')}: ${dayData.title}</h1>`;

                const allSlides = [
                    ...dayData.sections.hook, ...dayData.sections.i_do, ...dayData.sections.we_do, ...dayData.sections.you_do,
                    ...(dayData.practice_center.level1 || []),
                    ...(dayData.practice_center.level2 || []),
                    ...(dayData.practice_center.level3 || [])
                ];

                for (const slideData of allSlides) {
                    const savedAnswer = appState.progress[dayKey]?.lesson?.answers[slideData.id] || appState.progress[dayKey]?.practice?.answers[slideData.id];
                    if (!savedAnswer || (Array.isArray(savedAnswer) && savedAnswer.length === 0)) continue;

                    clone.innerHTML += `
                        <div style="padding: 10px; border-bottom: 1px solid #d3c5b4;">
                            <p style="font-weight: bold;">${slideData.prompt}</p>
                            <p style="color: #6a4c3f;"><strong>Answer:</strong> ${JSON.stringify(savedAnswer)}</p>
                        </div>
                    `;
                }
            }

            const canvas = await html2canvas(clone, { scale: 2 });
            document.body.removeChild(clone);

            const imgData = canvas.toDataURL('image/png');
            const pdf = new jsPDF({ orientation: 'portrait', unit: 'px', format: 'a4' });
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const imgProps = pdf.getImageProperties(imgData);
            const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
            let heightLeft = imgHeight;
            let position = 0;

            pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
            heightLeft -= pdfHeight;

            while (heightLeft > 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeight);
                heightLeft -= pdfHeight;
            }
            pdf.save('rpg-word-problems-log.pdf');
        };

        // --- START THE APP ---
        init();
    });
    </script>
</body>
</html>
