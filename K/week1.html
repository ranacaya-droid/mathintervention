<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Interactive Lesson: Numbers 1-5</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDKs (compat for simple drop-in) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <style>
    body { font-family: 'Comic Sans MS','Chalkboard SE','Marker Felt',sans-serif; user-select:none; }
    .slide { display:none; }
    .active-slide { display:block; }
    .active-tab { background-color:#10b981; color:white; }
    .tab { transition:all .3s ease; }
    .draggable { cursor:grab; touch-action:none; }
    .dragging { opacity:.4; }
    .ghost-drag { position:absolute; z-index:1000; pointer-events:none; opacity:.8; }
    .drop-target { transition: background-color .2s ease, transform .2s ease; }
    .drop-target.over { background-color:#a7f3d0; transform:scale(1.05); }
    .feedback-modal { display:none; }
    .feedback-modal.show { display:flex; }
    .auto-grow-textarea { overflow-y:hidden; resize:none; }
    .confetti { position:absolute; width:10px; height:10px; background:#f00; opacity:0; }
    @keyframes confetti-fall { 0%{transform:translateY(-100vh) rotate(0deg); opacity:1;} 100%{transform:translateY(100vh) rotate(720deg); opacity:0;} }
    .slide-content { animation:fadeIn .5s ease-in-out; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
    .button-pop { transition:transform .1s ease; }
    .button-pop:hover { transform:scale(1.05); }
    /* role/room badge */
    .badge { font-size:12px; }
    .disabled-nav { pointer-events:none; opacity:.5; }
  </style>
</head>
<body class="bg-sky-100 text-gray-800 flex flex-col h-screen overflow-hidden">

  <!-- Header with Tabs, Role/Room badge, Download Button -->
  <header class="bg-white shadow-md p-2 flex justify-between items-center">
    <nav id="day-tabs" class="flex space-x-2 overflow-x-auto"></nav>

    <div class="flex items-center gap-2">
      <span id="role-room-badge" class="badge px-2 py-1 rounded-full bg-gray-200 text-gray-700"></span>
      <button id="download-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg button-pop flex-shrink-0">
        Download Work
      </button>
    </div>
  </header>

  <!-- Main Content Area -->
  <main id="main-content" class="flex-1 overflow-y-auto p-4 sm:p-6 md:p-8">
    <div id="lesson-container" class="max-w-4xl mx-auto bg-white rounded-2xl shadow-lg p-6"></div>
  </main>

  <!-- Fixed Navigation Footer -->
  <footer class="bg-white shadow-t-md p-4 flex justify-between items-center border-t">
    <button id="prev-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg button-pop">Back</button>
    <div id="slide-counter" class="text-lg font-bold text-center"></div>
    <button id="next-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-6 rounded-lg button-pop">Next!</button>
  </footer>

  <!-- Feedback Modal -->
  <div id="feedback-modal" class="feedback-modal fixed inset-0 bg-black bg-opacity-50 justify-center items-center z-50">
    <div class="bg-white rounded-lg p-8 text-center shadow-xl max-w-sm mx-auto">
      <div id="feedback-icon" class="text-6xl mb-4"></div>
      <p id="feedback-text" class="text-2xl font-bold mb-6"></p>
      <button id="feedback-close-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-8 rounded-lg">OK</button>
    </div>
  </div>

  <!-- Confetti Container -->
  <div id="confetti-container" class="absolute inset-0 pointer-events-none overflow-hidden z-40"></div>

  <!-- ðŸ”‘ FIREBASE CONFIG â€” paste your real values here -->
  <script>
    // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCXS6CNUDQ323H002lxwjeiEEKwXP4tVLU",
  authDomain: "lesson-sync-a223a.firebaseapp.com",
  projectId: "lesson-sync-a223a",
  storageBucket: "lesson-sync-a223a.firebasestorage.app",
  messagingSenderId: "906128715071",
  appId: "1:906128715071:web:347ea08f4d864fde02778a"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
    window.__FIREBASE_CONFIG__ = {
      apiKey: "PASTE_ME",
      authDomain: "PASTE_ME.firebaseapp.com",
      projectId: "PASTE_ME",
      storageBucket: "PASTE_ME.appspot.com",
      messagingSenderId: "PASTE_ME",
      appId: "PASTE_ME"
    };
  </script>

  <script>
/* -------------------------- YOUR ORIGINAL APP -------------------------- */
/* (I kept your code intact, then added the sync block at the end.) */

const lessonData = { /* â€¦ your full lessonData object (unchanged) â€¦ */ };
// For brevity in this snippet, Iâ€™m not re-pasting your giant lessonData.
// Use the exact lessonData you sent me.

let currentDay = 0;
let currentSlide = 0;
let progressData = {};
let isPracticeCenter = false;
let practiceProgress = {};

const lessonContainer = document.getElementById('lesson-container');
const dayTabsContainer = document.getElementById('day-tabs');
const prevBtn = document.getElementById('prev-btn');
const nextBtn = document.getElementById('next-btn');
const slideCounter = document.getElementById('slide-counter');
const downloadBtn = document.getElementById('download-btn');
const feedbackModal = document.getElementById('feedback-modal');
const feedbackIcon = document.getElementById('feedback-icon');
const feedbackText = document.getElementById('feedback-text');
const feedbackCloseBtn = document.getElementById('feedback-close-btn');

/* -------------------------- NEW: SYNC FLAGS -------------------------- */
const params = new URLSearchParams(location.search);
const IS_TEACHER = params.get('teacher') === '1';
const ROOM_ID = params.get('room') || 'default';
document.getElementById('role-room-badge').textContent =
  `${IS_TEACHER ? 'Teacher' : 'Student'} â€¢ room: ${ROOM_ID}`;

/* --------------------- INIT + (later) FIREBASE SYNC ------------------- */
document.addEventListener('DOMContentLoaded', async () => {
  // restore progress (unchanged)
  if (typeof loadedProgress !== 'undefined') {
    progressData = loadedProgress;
  } else {
    const saved = localStorage.getItem('kindergartenNumbersProgress');
    if (saved) progressData = JSON.parse(saved);
  }
  for (const key in progressData) {
    if (key.startsWith('p-') && progressData[key].completed) {
      const dayIndex = parseInt(key.match(/d(\d+)/)[1]);
      practiceProgress[dayIndex] = (practiceProgress[dayIndex] || 0) + 1;
    }
  }

  initTabs();
  showSlide(currentDay, currentSlide);

  prevBtn.addEventListener('click', () => { navigatePrev(); syncPush(); });
  nextBtn.addEventListener('click', () => { navigateNext(); syncPush(); });
  downloadBtn.addEventListener('click', downloadWork);
  feedbackCloseBtn.addEventListener('click', hideFeedback);

  // Disable navigation on student devices (they still interact on slide)
  if (!IS_TEACHER) {
    prevBtn.classList.add('disabled-nav');
    nextBtn.classList.add('disabled-nav');
  }

  // ðŸ”¥ Start Firebase sync
  await initFirebaseSync();
});

/* -------------------------- NAV / RENDER (yours) -------------------------- */
function initTabs() {
  dayTabsContainer.innerHTML = '';
  lessonData.days.forEach((day, index) => {
    const tab = document.createElement('button');
    tab.textContent = day.title;
    tab.className = `tab font-bold py-2 px-4 rounded-lg flex-shrink-0 ${index === currentDay ? 'active-tab' : 'bg-gray-200 hover:bg-gray-300'}`;
    tab.onclick = () => {
      if (!IS_TEACHER) return; // students can't change day
      isPracticeCenter = false;
      currentDay = index;
      currentSlide = 0;
      initTabs();
      showSlide(currentDay, currentSlide);
      syncPush();
    };
    dayTabsContainer.appendChild(tab);
  });
}

function navigatePrev() {
  const slideSet = isPracticeCenter ? lessonData.days[currentDay].practiceCenter : lessonData.days[currentDay].slides;
  if (currentSlide > 0) { currentSlide--; showSlide(currentDay, currentSlide); }
}
function navigateNext() {
  const slideSet = isPracticeCenter ? lessonData.days[currentDay].practiceCenter : lessonData.days[currentDay].slides;
  if (currentSlide < slideSet.length - 1) { currentSlide++; showSlide(currentDay, currentSlide); }
}
function goToPracticeCenter(dayIndex) {
  if (!IS_TEACHER) return; // students canâ€™t switch mode themselves
  isPracticeCenter = true;
  currentDay = dayIndex;
  currentSlide = 0;
  showSlide(currentDay, currentSlide);
  syncPush();
}

function showSlide(dayIndex, slideIndex) {
  const slideSet = isPracticeCenter ? lessonData.days[dayIndex].practiceCenter : lessonData.days[dayIndex].slides;
  const slideData = slideSet[slideIndex];
  lessonContainer.innerHTML = `<div class="slide-content"></div>`;
  const contentWrapper = lessonContainer.querySelector('.slide-content');

  let html = '';
  if (isPracticeCenter) html += renderPracticeHeader(dayIndex, slideIndex);

  switch (slideData.type) {
    case 'title': html += `<h1 class="text-4xl font-bold text-center text-emerald-600 mb-4">${slideData.title}</h1><p class="text-xl text-center">${slideData.text}</p>`; break;
    case 'hook':
    case 'instruction': html += `<h2 class="text-3xl font-bold text-blue-600 mb-4">${slideData.title}</h2><p class="text-lg">${slideData.text}</p>`; break;
    case 'drag-drop-sort': html += renderDragDropSort(slideData); break;
    case 'multiple-choice': html += renderMultipleChoice(slideData); break;
    case 'true-false': html += renderTrueFalse(slideData); break;
    case 'short-answer': html += renderShortAnswer(slideData); break;
    case 'drag-drop-sequence': html += renderDragDropSequence(slideData); break;
    case 'drawing': html += renderDrawingCanvas(slideData); break;
    case 'practice-center-gate':
      html += `<div class="text-center"><h2 class="text-3xl font-bold mb-6">Great work today!</h2>
               <button ${IS_TEACHER ? '' : 'disabled class="opacity-50 cursor-not-allowed"'}
                onclick="goToPracticeCenter(${slideData.dayIndex})"
                class="bg-yellow-400 hover:bg-yellow-500 text-gray-800 font-bold py-4 px-8 rounded-full text-2xl button-pop">
                Let's Practice!
               </button></div>`;
      break;
  }
  contentWrapper.innerHTML = html;
  activateSlide(slideData, dayIndex, slideIndex);
  updateNavButtons();
  updateSlideCounter();
}

/* â€¦ keep all your existing renderers, DnD logic, drawing, feedback, persistence, etc. exactly as you had it â€¦ */
/* (Iâ€™m omitting here to keep this message shorter; use the exact code you sent.) */

/* -------------------------- SAVE PROGRESS (yours) -------------------------- */
function saveProgress() {
  try { localStorage.setItem('kindergartenNumbersProgress', JSON.stringify(progressData)); }
  catch (e) { console.error("Could not save progress:", e); }
}
function downloadWork() {
  const currentHtml = document.documentElement.outerHTML;
  const scriptToInject = `<script>const loadedProgress = ${JSON.stringify(progressData)};<\/script>`;
  const modifiedHtml = currentHtml.replace(/(<body[^>]*>)/i, `$1${scriptToInject}`);
  const blob = new Blob([modifiedHtml], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'my-number-lesson.html';
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
}

/* ========================== ðŸ”¥ SYNC LAYER ========================== */

let _app, _db, _auth, _roomRef, _unsubSnap = null;
let _isApplyingRemote = false; // prevent feedback loops

async function initFirebaseSync() {
  try {
    _app = firebase.initializeApp(window.__FIREBASE_CONFIG__);
    _auth = firebase.auth();
    _db = firebase.firestore();

    // Teacher signs in (needed to write because of rules)
    if (IS_TEACHER) { await _auth.signInAnonymously(); }

    _roomRef = _db.collection('rooms').doc(ROOM_ID);

    // First-time default (teacher seeds state)
    if (IS_TEACHER) {
      await _roomRef.set({
        day: currentDay,
        slide: currentSlide,
        isPractice: isPracticeCenter,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
    }

    // Subscribe for both roles; students will apply, teacher mostly ignores
    _unsubSnap = _roomRef.onSnapshot((doc) => {
      const data = doc.data();
      if (!data) return;

      // Students follow; teacher ignores remote (avoids jitter)
      if (!IS_TEACHER) {
        _isApplyingRemote = true;
        currentDay = data.day ?? 0;
        isPracticeCenter = !!data.isPractice;
        currentSlide = data.slide ?? 0;

        // Re-render UI to match teacher
        initTabs();
        showSlide(currentDay, currentSlide);
        _isApplyingRemote = false;
      }
    });

  } catch (e) {
    console.error('Firebase sync init failed:', e);
    alert('Sync not available. Check your Firebase config.');
  }
}

async function syncPush() {
  if (!IS_TEACHER) return;          // students never write
  if (!_roomRef || _isApplyingRemote) return; // no loops
  try {
    await _roomRef.set({
      day: currentDay,
      slide: currentSlide,
      isPractice: isPracticeCenter,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge: true });
  } catch (e) {
    console.error('Sync push failed:', e);
  }
}

/* ======================== END SYNC LAYER ======================== */

  </script>
</body>
</html>
